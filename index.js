const express = require('express');
const { Telegraf, Markup } = require('telegraf');
require('dotenv').config();

const app = express();
const bot = new Telegraf(process.env.BOT_TOKEN);

// Ð”Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð° JSON Ñ‚ÐµÐ»Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¾Ñ‚ Telegram
app.use(express.json());

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Ð³Ð»Ð°Ð²Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð»Ð¸ ÑÐµÑ€Ð²ÐµÑ€)
app.get('/', (req, res) => {
  res.send('Bot is live and working!');
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ Telegram Ñ‡ÐµÑ€ÐµÐ· Webhook
app.post(`/${process.env.BOT_TOKEN}`, (req, res) => {
  bot.handleUpdate(req.body)
    .then(() => {
      res.sendStatus(200); // ÐžÑ‚Ð²ÐµÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹, Telegram Ð·Ð½Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½
    })
    .catch(err => {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹:', err);
      res.sendStatus(500); // Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
    });
});

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ð¼ Webhook Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
const webhookUrl = `https://egor-bot.onrender.com/${process.env.BOT_TOKEN}`;
bot.telegram.setWebhook(webhookUrl).then(() => {
  console.log('Webhook ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð½Ð°:', webhookUrl);
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
async function checkSubscription(userId, ctx) {
  try {
    const member = await ctx.telegram.getChatMember(process.env.CHANNEL_ID, userId);
    return ['member', 'administrator', 'creator'].includes(member.status);
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸:', error);
    return false;
  }
}

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ðŸ”„ Ð¡Ñ‚Ð°Ñ€Ñ‚"
async function handleStartCommand(ctx) {
  const userId = ctx.from.id;
  const isSubscribed = await checkSubscription(userId, ctx);

  if (isSubscribed) {
    await ctx.reply(
      'ÐÐ°Ð¶Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» ðŸ“š Ñ Ñ‚ÐµÐ¾Ñ€Ð¸ÐµÐ¹ Ð¿Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ð¸ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°Ð¼Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡! âœ¨',
      Markup.inlineKeyboard([
        [Markup.button.callback('ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ð¸', 'file_1')],
       // [Markup.button.callback('ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» 2', 'file_2')],
      ])
    );
  } else {
    await ctx.reply(
      'Ð£Ð¿Ñ!ðŸ˜± ÐšÐ°Ð¶ÐµÑ‚ÑÑ, Ñ‚Ñ‹ Ð½Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð»ÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»! ÐŸÐ¾Ð´Ð¿Ð¸ÑˆÐ¸ÑÑŒ Ð¸ Ð²ÑÑ‘ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑÑ!âœ…',
      Markup.inlineKeyboard([
        [Markup.button.url('ðŸ”— ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»', `https://t.me/${process.env.CHANNEL_ID.replace('@', '')}`)],
        [Markup.button.callback('ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ', 'check_subscription')],
      ])
    );
  }

  // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ "Ð¡Ñ‚Ð°Ñ€Ñ‚" Ð²Ð½Ð¸Ð·Ñƒ
  await ctx.reply(
    'Ð•ÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ "Ð¡Ñ‚Ð°Ñ€Ñ‚"!',
    Markup.keyboard([['ðŸ”„ Ð¡Ñ‚Ð°Ñ€Ñ‚']]).resize().oneTime(false)
  );
}

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.start(handleStartCommand);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð²Ð²Ð¾Ð´Ð° Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ðŸ”„ Ð¡Ñ‚Ð°Ñ€Ñ‚"
bot.hears('ðŸ”„ Ð¡Ñ‚Ð°Ñ€Ñ‚', handleStartCommand);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ"
bot.action('check_subscription', async (ctx) => {
  const userId = ctx.from.id;
  const isSubscribed = await checkSubscription(userId, ctx);

  if (isSubscribed) {
    await ctx.reply(
      'ÐÐ°Ð¶Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» ðŸ“š Ñ Ñ‚ÐµÐ¾Ñ€Ð¸ÐµÐ¹ Ð¿Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ð¸ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°Ð¼Ð¸ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡! âœ¨',
      Markup.inlineKeyboard([
        [Markup.button.callback('ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð¿Ð¾ Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ð¸', 'file_1')],
       // [Markup.button.callback('ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» 2', 'file_2')],
      ])
    );
  } else {
    await ctx.reply(
      'Ð£Ð¿Ñ!ðŸ˜± ÐšÐ°Ð¶ÐµÑ‚ÑÑ, Ñ‚Ñ‹ Ð½Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð»ÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»! ÐŸÐ¾Ð´Ð¿Ð¸ÑˆÐ¸ÑÑŒ Ð¸ Ð²ÑÑ‘ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑÑ!âœ…',
      Markup.inlineKeyboard([
        [Markup.button.url('ðŸ”— ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»', `https://t.me/${process.env.CHANNEL_ID.replace('@', '')}`)],
        [Markup.button.callback('ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ', 'check_subscription')],
      ])
    );
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿Ð¾Ðº ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
bot.action('file_1', async (ctx) => {
  const userId = ctx.from.id;
  const isSubscribed = await checkSubscription(userId, ctx);

  if (isSubscribed) {
    try {
      await ctx.reply('Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° Ð½Ð°Ñ‡Ð°Ð»Ð°ÑÑŒ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ...');
      await ctx.replyWithDocument({ source: './files/geom.pdf', filename: 'geom.pdf' });
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ñ„Ð°Ð¹Ð»Ð° 1:', error);
      ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
    }
  } else {
    await ctx.reply(
      'Ð”Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð¼Ð¾Ð¹ ÐºÐ°Ð½Ð°Ð»! âœ…',
      Markup.inlineKeyboard([
        [Markup.button.url('ðŸ”— ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»', `https://t.me/${process.env.CHANNEL_ID.replace('@', '')}`)],
        [Markup.button.callback('ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ', 'check_subscription')],
      ])
    );
  }
});

// bot.action('file_2', async (ctx) => {
 // const userId = ctx.from.id;
 // const isSubscribed = await checkSubscription(userId, ctx);

 // if (isSubscribed) {
    //try {
   //   await ctx.reply('Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° Ð½Ð°Ñ‡Ð°Ð»Ð°ÑÑŒ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ...');
   //   await ctx.replyWithDocument({ source: './files/file2.pdf', filename: 'file2.pdf' });
  //  } catch (error) {
   //   console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ñ„Ð°Ð¹Ð»Ð° 2:', error);
   //   ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
   // }
  //} else {
  //  await ctx.reply(
  //    'Ð”Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð½Ð°Ñˆ ÐºÐ°Ð½Ð°Ð»! âœ…',
   //   Markup.inlineKeyboard([
  //      [Markup.button.url('ðŸ”— ÐŸÐ¾Ð´Ð¿Ð¸ÑÐ°Ñ‚ÑŒÑÑ Ð½Ð° ÐºÐ°Ð½Ð°Ð»', `https://t.me/${process.env.CHANNEL_ID.replace('@', '')}`)],
  //      [Markup.button.callback('ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ', 'check_subscription')],
//      ])
 //   );
 // }
//});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Express
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
